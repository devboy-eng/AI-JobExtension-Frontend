<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Job Extraction Debugger</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9fafb;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .btn {
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            margin: 10px;
            font-weight: 500;
        }
        .btn:hover { background: #1d4ed8; }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: 500;
        }
        .status.success { background: #d1ecf1; color: #0c5460; }
        .status.error { background: #f8d7da; color: #721c24; }
        .debug-output {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .solution {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß LinkedIn Job Extraction Debugger</h1>
        <p>Debug the "Error analyzing job posting" issue by testing job extraction manually.</p>
        
        <div id="status"></div>
        
        <div class="debug-section">
            <h3>üåê Step 1: Test with LinkedIn Job URL</h3>
            <p>Enter a LinkedIn job URL to simulate extraction:</p>
            
            <div class="form-group">
                <label>LinkedIn Job URL:</label>
                <input type="text" id="linkedinUrl" placeholder="https://www.linkedin.com/jobs/view/12345" 
                       value="https://www.linkedin.com/jobs/view/3777296542">
            </div>
            
            <button class="btn" onclick="testLinkedInUrl()">üîç Test URL Pattern</button>
            <button class="btn" onclick="simulateJobExtraction()">üìã Simulate Job Extraction</button>
        </div>

        <div class="debug-section">
            <h3>üß™ Step 2: Test Extension Message Handling</h3>
            <button class="btn" onclick="testExtensionCommunication()">üì° Test Extension Communication</button>
            <button class="btn" onclick="testBackendConnection()">üîó Test Backend Connection</button>
        </div>

        <div class="debug-section">
            <h3>üìä Debug Output</h3>
            <div class="debug-output" id="debugOutput">Ready for debugging...</div>
        </div>

        <div class="solution">
            <h4>üí° Common Solutions:</h4>
            <ul>
                <li><strong>URL Issue:</strong> Make sure you're on a LinkedIn job page with format: <code>/jobs/view/[id]</code></li>
                <li><strong>Extension Issue:</strong> Try reloading the extension in Chrome Extensions page</li>
                <li><strong>LinkedIn Layout:</strong> LinkedIn updates their layout frequently - selectors may need updating</li>
                <li><strong>Backend Issue:</strong> Ensure backend is running on port 4003</li>
            </ul>
        </div>
    </div>

    <script>
        function log(message) {
            const output = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function testLinkedInUrl() {
            const url = document.getElementById('linkedinUrl').value;
            log(`üîç Testing URL: ${url}`);
            
            const isJobsPage = url.includes('linkedin.com/jobs');
            const hasJobId = url.includes('currentJobId=') || url.includes('/view/') || url.includes('/jobs/');
            
            log(`  ‚úì Is Jobs Page: ${isJobsPage}`);
            log(`  ‚úì Has Job ID: ${hasJobId}`);
            log(`  ‚úì Valid LinkedIn Job URL: ${isJobsPage && hasJobId}`);
            
            if (isJobsPage && hasJobId) {
                showStatus('‚úÖ URL pattern is valid for LinkedIn job extraction', 'success');
                log(`‚úÖ URL validation passed`);
            } else {
                showStatus('‚ùå URL pattern is not valid. Please use a LinkedIn job posting URL.', 'error');
                log(`‚ùå URL validation failed`);
            }
        }

        function simulateJobExtraction() {
            log(`üìã Simulating job data extraction...`);
            
            // Simulate mock job data that would be extracted
            const mockJobData = {
                title: "Senior Full Stack Developer",
                company: "Google",
                location: "San Francisco, CA",
                description: "We are looking for a Senior Full Stack Developer with JavaScript, Python, React, and AWS experience...",
                requirements: ["5+ years experience", "JavaScript/Python", "React", "AWS"],
                skills: ["javascript", "python", "react", "aws", "leadership"],
                experience: "Senior",
                jobType: "Hybrid",
                url: document.getElementById('linkedinUrl').value,
                extractedAt: new Date().toISOString()
            };
            
            log(`  ‚úì Mock Title: ${mockJobData.title}`);
            log(`  ‚úì Mock Company: ${mockJobData.company}`);
            log(`  ‚úì Mock Description Length: ${mockJobData.description.length} chars`);
            log(`  ‚úì Mock Skills: ${mockJobData.skills.join(', ')}`);
            
            showStatus('‚úÖ Mock job data extraction successful', 'success');
            log(`‚úÖ Mock extraction completed`);
            
            // Test if this data would work with the backend
            testWithMockData(mockJobData);
        }

        async function testWithMockData(jobData) {
            log(`ü§ñ Testing mock data with AI backend...`);
            
            try {
                const response = await fetch('http://localhost:4003/api/ai/customize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jobData: jobData,
                        profileData: {
                            name: "Test User",
                            designation: "Software Developer",
                            skills: "JavaScript, Software Development, Team Leadership",
                            workExperience: [{
                                designation: "Software Developer",
                                company: "Test Company",
                                description: "Developing software solutions."
                            }]
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`  ‚úì Backend Response: ${result.success ? 'Success' : 'Failed'}`);
                    log(`  ‚úì ATS Score: ${result.data?.atsScore || 'N/A'}`);
                    log(`  ‚úì Keywords Matched: ${result.data?.keywordsMatched?.length || 0}`);
                    showStatus('‚úÖ Backend integration test passed', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`  ‚ùå Backend Error: ${error.message}`);
                showStatus(`‚ùå Backend test failed: ${error.message}`, 'error');
            }
        }

        function testExtensionCommunication() {
            log(`üì° Testing Chrome extension communication...`);
            
            // Check if we're in an extension context
            if (typeof chrome !== 'undefined' && chrome.tabs) {
                log(`  ‚úì Chrome APIs available`);
                
                // Try to get current tab
                chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
                    if (tabs && tabs.length > 0) {
                        const currentTab = tabs[0];
                        log(`  ‚úì Current Tab: ${currentTab.url}`);
                        
                        if (currentTab.url.includes('linkedin.com/jobs')) {
                            log(`  ‚úì On LinkedIn jobs page`);
                            showStatus('‚úÖ Extension communication test passed', 'success');
                        } else {
                            log(`  ‚ö†Ô∏è  Not on LinkedIn jobs page`);
                            showStatus('‚ö†Ô∏è Not on LinkedIn - extension may not work', 'error');
                        }
                    } else {
                        log(`  ‚ùå No active tab found`);
                        showStatus('‚ùå Could not access current tab', 'error');
                    }
                });
            } else {
                log(`  ‚ùå Chrome extension APIs not available`);
                log(`  ‚ÑπÔ∏è  This test needs to run within Chrome extension context`);
                showStatus('‚ùå Not running in Chrome extension context', 'error');
            }
        }

        async function testBackendConnection() {
            log(`üîó Testing backend connection on port 4003...`);
            
            try {
                const response = await fetch('http://localhost:4003/health');
                
                if (response.ok) {
                    const health = await response.json();
                    log(`  ‚úì Backend Status: ${health.status}`);
                    log(`  ‚úì Backend Service: ${health.service}`);
                    showStatus('‚úÖ Backend connection successful', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`  ‚ùå Backend Connection Error: ${error.message}`);
                if (error.message.includes('Failed to fetch')) {
                    log(`  üí° Solution: Start backend with: PORT=4003 node start-backend.js`);
                }
                showStatus(`‚ùå Backend connection failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        window.onload = () => {
            log('üîß LinkedIn Job Extraction Debugger ready');
            showStatus('Ready to debug LinkedIn job extraction issues', 'success');
        };
    </script>
</body>
</html>